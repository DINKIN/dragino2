### Set up Asterisk config files
# Remove old files
rm /etc/asterisk/dragino.sip.conf >> /dev/null
rm /etc/asterisk/softphone.sip.conf >> /dev/null

# SIP server Settings
ENABLE=`uci get voip.sip_server.enablesip`
REGISTER=`uci get voip.sip_server.register`
USERNAME=`uci get voip.sip_server.username`
FROMUSERNAME=`uci get voip.sip_server.fromusername`
SECRET=`uci get voip.sip_server.secret` # May be empty
HOST=`uci get voip.sip_server.host`
REGHOST=`uci get voip.sip_server.host`


#PROXY=`uci get voip.asterisk.proxy`
CODEC1=`uci get voip.asterisk.codec1`
CODEC2=`uci get voip.asterisk.codec2`
CODEC3=`uci get voip.asterisk.codec3`
ENABLENAT=`uci get voip.asterisk.enablenat`
EXTERNIP=`uci get voip.asterisk.externip`

# Get localnet and netmask from br-lan settings
LOCALNET=`uci get network.lan.ipaddr | awk -F. '{print $1"."$2"."$3"."0}'`
LOCALNETMASK=`uci get network.lan.netmask`

# Get Asterisk SIP settings
if [ $ENABLE = "1" ]; then
ENFLAG=" "
else
ENFLAG=";"
fi

if [ $REGISTER = "1" ]; then
REGFLAG=" "
else
REGFLAG=";"
fi

if [ $ENABLENAT = "1" ]; then
ENABLENATFLAG=" "
else
ENABLENATFLAG=";"
fi

# Check whether device is already at Softphone Master IP address
CURRENTOCTET4=`uci show network.lan.ipaddr | cut -d = -f 2 | cut -d . -f 4`

# If so, set new IP addr to default of .20 in case device is made non-Master
# and the user forgets to change the IP address in the web UI at the same time


#--------------------------------------------

# Create new Asterisk 'dragino.sip.conf' include file
# Everything from here to EOF will be written to the file
cat > /etc/asterisk/dragino.sip.conf << EOF

;-------------------------------
; /etc/asterisk/dragino.sip.conf
; -----------------------------
; Config for SIP host [sipaccount] and Softphone calls
; CAUTION: This file is automatically generated by script /etc/init.d/config2asterisk
; Do not edit this file manually on a running system
; See /etc/config/voip for config parameters

; SIP host calls
; Configure for NAT if required
$ENABLENATFLAG localnet=$LOCALNET/$LOCALNETMASK                     
$ENABLENATFLAG externip=$EXTERNIP 

; Register to VoIP Provider
$REGFLAG $ENFLAG register => $USERNAME:$SECRET@$REGHOST

[sipaccount]
$ENFLAG host=$HOST
$ENFLAG secret=$SECRET
$ENFLAG defaultuser=$USERNAME
$ENFLAG fromuser=$USERNAME
$ENFLAG fromdomain=$REGHOST

insecure=port,invite
type=friend
disallow=all
allow=$CODEC1,$CODEC2,$CODEC3
dtmfmod=rfc2833
qualify=yes
canreinvite=nonat
context=incoming-vsp
alwaysauthreject=yes
;----------------------------

; Softphone support include file
;-------------------------------
; Defines softphone extensions.
#include "softphone.sip.conf"
;-------------------------------

EOF
#-----------------------------------------------------------




# Create 'softphone.sip.conf' include file
# Everything from here to EOF will be written to the file

cat > /etc/asterisk/softphone.sip.conf << EOF
;----------------------------------------------
; /etc/asterisk/softphone.sip.conf
; ---------------------------------------------

; softphone users
; CAUTION: This is an automatically generated file by script /etc/init.d/config2asterisk
; Do not edit this file manually on a running system
; See /etc/config/voip for config parameters

[softph](!)
; Template of settings
type=friend
context=incoming-softphone
host=dynamic
disallow=all
allow=ulaw
dtmfmode=rfc2833
qualify=yes
canreinvite=nonat
alwaysauthreject=yes
mailbox=null

EOF
# ------------------------------------------------------------------

# Distribute User 
# Add clients to softphone.sip.conf file 
USER_LIST=`uci show voip | grep '=clients' | awk '{gsub(/voip./,"")} {gsub(/=clients/,"")} {print $1}'`
ANALOG_NUMBER=""
for client in $USER_LIST; do
	# check if its type is clients
	if [ `uci get voip.$client` == "clients" ] && [ ! -z `uci get voip.$client.number` ] ;then
		if [ `uci get voip.$client.ext_type` == "softphone" ]; then
			USER=`uci get voip.$client.username`
			NUMBER=`uci get voip.$client.number`
			PASSWORD=`uci get voip.$client.password`
			echo "[$NUMBER](softph)" >> /etc/asterisk/softphone.sip.conf
			echo username=$USER >> /etc/asterisk/softphone.sip.conf
			echo secret=$PASSWORD >> /etc/asterisk/softphone.sip.conf
			echo "" >> /etc/asterisk/softphone.sip.conf
		elif [ `uci get voip.$client.ext_type` == "analog" ]; then
			ANALOG_NUMBER=`uci get voip.$client.number`
		fi
	fi
		
	# remove blank user
	if [ -z `uci get voip.$client.number` ]; then
		uci delete voip.$client
	fi
done

uci commit voip

/usr/bin/config2extension $ANALOG_NUMBER

# Make sure Asterisk custom include files exist for user defined functions.
touch /etc/asterisk/custom.incoming.extensions.conf
touch /etc/asterisk/custom.extensions.conf
touch /etc/asterisk/custom.sip.conf
# -----------------------------------------------------


# Run init to restart Asterisk

# Start or stop Asterisk now and enable on boot up if required
ENABLE_AST=`uci get voip.asterisk.enableast`
if [ $ENABLE_AST = "1" ]; then
    /etc/init.d/asterisk restart
    /etc/init.d/asterisk enable
else
    /etc/init.d/asterisk stop
    rm /etc/rc.d/S99asterisk
fi

